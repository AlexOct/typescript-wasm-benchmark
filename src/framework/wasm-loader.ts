/**
 * WASM Module Loader - Vite standard loading method
 * Use ES Module import, can be used as third-party library
 */

// Import WASM module (ES6 module generated by Emscripten)
import createWasmModule from '../wasm/array_processor.js';

export interface WasmModuleInstance {
  _malloc(size: number): number;
  _free(ptr: number): void;
  getValue(ptr: number, type: string): number;
  setValue(ptr: number, value: number, type: string): void;
  ccall(
    funcName: string,
    returnType: string | null,
    argTypes: string[],
    args: any[]
  ): any;
  cwrap(
    funcName: string,
    returnType: string | null,
    argTypes: string[]
  ): (...args: any[]) => any;
  HEAPF32: Float32Array;
  HEAP32: Int32Array;
  HEAPU32: Uint32Array;
}

let wasmModuleInstance: WasmModuleInstance | null = null;

/**
 * Initialize WASM module
 */
export async function initWasmModule(): Promise<WasmModuleInstance> {
  if (wasmModuleInstance) {
    return wasmModuleInstance;
  }

  console.log('üîÑ Loading WASM module...');

  try {
    // Call Emscripten-generated factory function
    const module = await createWasmModule();

    if (!module) {
      throw new Error('WASM module factory returned null');
    }

    wasmModuleInstance = module as WasmModuleInstance;

    console.log('‚úÖ WASM module loaded successfully');

    return wasmModuleInstance;
  } catch (error) {
    console.error('‚ùå Failed to load WASM module:', error);
    throw new Error('Failed to initialize WebAssembly module');
  }
}

/**
 * Get loaded WASM module
 */
export function getWasmModuleInstance(): WasmModuleInstance {
  if (!wasmModuleInstance) {
    throw new Error('WASM module not initialized. Call initWasmModule() first.');
  }
  return wasmModuleInstance;
}

/**
 * Export interface for external use
 */
export const WasmLoader = {
  init: initWasmModule,
  getInstance: getWasmModuleInstance,
};
